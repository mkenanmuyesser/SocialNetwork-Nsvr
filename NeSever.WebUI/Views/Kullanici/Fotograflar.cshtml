@{
    ViewData["Title"] = "Fotoğraflar";
    Layout = "~/Views/Shared/_ProfileLayout.cshtml";
}
@using NeSever.Common.Models.Uyelik
@model NeSever.Common.Models.Uyelik.KullaniciResimVM
@section Content{
    <style type="text/css">
        .block-btn {
            padding-right: 0px;
        }
        .upload-photo-item svg {
            margin-bottom: 30px;
            width: 139px;
            height: 20px;
        }
    </style>

    <div class="row">
        <div class="col col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="ui-block responsive-flex">
                <div class="ui-block-title">
                    <div class="h6 title">Fotoğraf Galerisi</div>

                    <div class="block-btn align-right">
                        <a href="javascript:;" onclick="kullaniciProfilResimModalGetir();" class="btn btn-primary btn-md-2">Profil Fotoğrafını Değiştir</a>
                        <a href="#" onclick="duvarResmiDegistir()" class="btn btn-secondary btn-md-2">Duvar Resmini Değiştir</a>
                        <a href="#" data-toggle="modal" data-target="#update-photo" class="btn btn-primary btn-md-2">Galerine Fotoğraf Yükle</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="choose-from-header-photo" tabindex="-1" role="dialog" aria-labelledby="fav-page-popup" aria-hidden="true">
        <div class="modal-dialog window-popup choose-from-my-photo" role="document">
            <div class="modal-content">
                <a href="#" class="close icon-close" aria-label="Kapat" data-dismiss="modal">
                    <svg class="olymp-close-icon"><use xlink:href="#olymp-close-icon"></use></svg>
                </a>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status" id="loadingDiv">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>

                <div class="modal-body" id="divModalDuvarResmi">

                </div>
            </div>
        </div>
    </div>
 
    <form id="_form" enctype="multipart/form-data" method="post">
        <div class="modal fade" id="update-photo" tabindex="-1" role="dialog" aria-labelledby="update-header-photo" aria-hidden="true">
            <div class="modal-dialog window-popup update-header-photo" role="document">
                <div class="modal-content">
                    <a href="#" class="close icon-close" data-dismiss="modal" aria-label="Close">
                        <svg class="olymp-close-icon"><use xlink:href="#olymp-close-icon"></use></svg>
                    </a>

                    <div class="modal-header">
                        <h6 class="title">Fotoğraf Yükle</h6>
                    </div>

                    <div class="modal-body">

                        <a href="javascript:;" class="upload-photo-item" id="openFileFotograf" style="float:left;width:100%">
                            <div>
                                <svg class="olymp-computer-icon"><use xlink:href="#olymp-computer-icon"></use></svg>
                                <input type="file" name="file" id="fileInputHiddenFotograf" class="inputfile" style="visibility:hidden" onclick="this.value=null"/>
                                <h6>Fotoğraf Yükle</h6>
                                <span>Dosya Dizinini Aç</span>
                            </div>
                        </a>

                        <div id="divButtonFotograf" style="display:none;float:left;width:100%">
                            <div class="fileinput-new thumbnail" style="height: auto; width:100%;text-align:center" id="fileInputDivFotograf"></div>
                            <div style="text-align: center; width: 100%;">
                                <textarea id="galeriFotografEkleAciklama" class="form-control" asp-for="ResimYorum" placeholder="Resim Yorum" maxlength="200"></textarea>
                            </div>
                            <div style="text-align: center;width: 100%;">
                                <button class="btn btn-primary" type="submit"> Yükle</button>
                                <button class="btn btn-secondary" onclick="FotografIptalEt()">Vazgeç</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div id="fotografGalerisi">

    </div> 

    <script type="text/javascript">
        $("#_form").on("submit", function (e) {
            var formElement = document.querySelector("#_form");
            var file_data = $('#fileInputHiddenFotograf')[0].files[0];

            if (file_data.size > 20971520) {

                event.preventDefault();
                Swal.fire({
                    title: 'Boyut Aşımı!',
                    text: '20 MB Büyük Resim Eklenemez',
                    icon: 'warning',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Kapat'
                });

            }
            else {
                var form_data = new FormData(formElement);

                for (var i = 0; i < file_data.length; i++) {
                    form_data.append('file', file_data);
                }

                event.preventDefault();
                $.ajax({
                    url: '/Kullanici/FotografYukle',
                    type: "Post",
                    cache: false,
                    async: false,
                    contentType: false,
                    processData: false,
                    data: form_data,
                    datatype: 'multipart/form-data',
                    success: function (sonuc) {
                        if (sonuc.Type == 1) {
                            Swal.fire({
                                title: 'İşlem Başarılı!',
                                text: "Fotoğraf Yüklendi!",
                                icon: 'success',
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Kapat'
                            }).then((result) => {
                                $('#update-photo').modal('hide')
                                FotografIptalEt();
                                fotografGalerisiGetir();
                                $.ajax({
                                    url: '/Kullanici/KullaniciFotografVarmi',
                                    type: "Get",
                                    success: function (data) {
                                        if (data.Type == 2) {
                                            $("#fotografSecList").empty();
                                            $('#fotografSecList').html('<a href="#" class="upload-photo-item" onclick="fotografYok();" style="float:left;width:100%"><svg class= "olymp-photos-icon" style = "float:left;width:100%" > <use xlink: href="#olymp-photos-icon"></use></svg ><h6 style="width:100%">Fotoğraflarımdan Seç</h6></a >');
                                        }
                                        else {
                                            $('#fotografSecList').empty();
                                            $('#fotografSecList').html('<a href="#" class="upload-photo-item" data-toggle="modal" data-target="#choose-from-my-photo" onclick="fotografSec();" style="float:left;width:100%"><svg class= "olymp-photos-icon" style = "float:left;width:100%" > <use xlink: href="#olymp-photos-icon"></use></svg ><h6 style="width:100%">Fotoğraflarımdan Seç</h6></a >');
                                        }
                                    }
                                });
                            });
                        }
                        else if (sonuc.ErrorMessage == "ResimOndanFazla") {
                            Swal.fire({
                                title: 'Uyarı!',
                                text: '10 taneden fazla resim yükleyemezsiniz',
                                icon: 'warning',
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Kapat'
                            }).then((result) => {
                                $('#update-photo').modal('hide')
                                FotografIptalEt();
                            });
                        }
                        else if (sonuc.Type == 2 && sonuc.ErrorMessage == "session") {
                            location.reload();
                        }
                        else {
                            Swal.fire({
                                title: 'Hata!',
                                text: '',
                                icon: 'error',
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Kapat'
                            });
                        }
                    },
                    error: function () {
                        alert("hata");
                    }
                });
            }
        });

        function fotografGalerisiGetir() {
                var middleContent = $('#fotografGalerisi');
                middleContent.html('');
                middleContent.load('@Url.Action("FotografGalerisi","Kullanici")');
        };

        fotografGalerisiGetir();

        var _validFileExtensions = [".png", ".jpg", ".jpeg", ".gif"];
        function ValidateFotograf(oForm) {
            var arrInputs = $('input#fileInputHiddenFotograf');
            for (var i = 0; i < arrInputs.length; i++) {
                var oInput = arrInputs[i];
                if (oInput.type == "file") {
                    var sFileName = oInput.value;
                    if (sFileName.length > 0) {
                        var blnValid = false;
                        for (var j = 0; j < _validFileExtensions.length; j++) {
                            var sCurExtension = _validFileExtensions[j];
                            if (sFileName.substr(sFileName.length - sCurExtension.length, sCurExtension.length).toLowerCase() == sCurExtension.toLowerCase()) {
                                blnValid = true;
                                break;
                            }
                        }

                        if (!blnValid) {
                            Swal.fire({
                                title: 'Hata!',
                                text: "Fotoğraf Yüklenemedi ! Lütfen jpg,jpeg,png,gif uzantılı dosyaları yükleyiniz. ",
                                icon: 'error',
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Kapat'
                            });

                            return false;
                        }
                    }
                }
            }

            return true;
        }

        function resimSil(resimId) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Fotoğraf silinecek",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sil',
                cancelButtonText: 'Vazgeç',

            }).then((result) => {
                if (result.value) {
                    $.ajax({
                        url: '/Kullanici/FotografSilGuncelle',
                        type: "Get",
                        data: { resimId: resimId },
                        success: function (data) {
                            Swal.fire({
                                title: 'İşlem Başarılı!',
                                text: "Fotoğraf Silindi!",
                                icon: 'success',
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Kapat'
                            }).then((sonuc) => {
                                $('#fotografGalerisi').html(data);
                                $.ajax({
                                    url: '/Kullanici/KullaniciFotografVarmi',
                                    type: "Get",
                                    success: function (data) {
                                        if (data.Type == 2) {
                                            $('#fotografSecList').empty();
                                            $('#fotografSecList').html('<a href="#" class="upload-photo-item" onclick="fotografYok();" style="float:left;width:100%"><svg class= "olymp-photos-icon" style = "float:left;width:100%" > <use xlink: href="#olymp-photos-icon"></use></svg ><h6 style="width:100%">Fotoğraflarımdan Seç</h6></a >');
                                        }
                                        else {
                                            $('#fotografSecList').empty();
                                            $('#fotografSecList').html('<a href="#" class="upload-photo-item" data-toggle="modal" data-target="#choose-from-my-photo" onclick="fotografSec();" style="float:left;width:100%"><svg class= "olymp-photos-icon" style = "float:left;width:100%" > <use xlink: href="#olymp-photos-icon"></use></svg ><h6 style="width:100%">Fotoğraflarımdan Seç</h6></a >');
                                        }
                                    }
                                });
                            });

                            ;
                        },
                        error: function () {
                            alert("hata");
                        }
                    });
                }
            });

        }

        $('#openFileFotograf').on('click', function (e) {
            e.stopPropagation();

            $('#fileInputHiddenFotograf')[0].click();
        })

        function openFileFotograf() {
            $('#fileInputHiddenFotograf').trigger('click');
        }

        function FotografIptalEt() {
            event.preventDefault();
            $('#galeriFotografEkleAciklama').val('');
            $('#fileInputDivFotograf').empty();
            $('#divButtonFotograf').css('display', 'none');
            $('#openFileFotograf').css('display', 'block');

        }

        $("#fileInputHiddenFotograf").change(function () {
            var sonuc = ValidateFotograf();
            //var sizeValidation =filevalidationFotograf();
            if (sonuc) {
                readURLFotograf(this);
            }
        });

        function readURLFotograf(input) {
            $('#fileInputDivFotograf').empty();
            for (var i = 0; i < input.files.length; i++) {
                if (input.files[i] && input.files[i]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {

                        $('#fileInputDivFotograf').append('<img  style="max-height:200px;max-width:150px" src="' + e.target.result + '"></img>');
                    }
                    reader.readAsDataURL(input.files[i]);
                }

            }
            $('#openFileFotograf').css('display', 'none');
            $('#divButtonFotograf').css('display', 'block');
        }

        function duvarResmiDegistir() {
            $('#choose-from-header-photo').modal('show');
            $.ajax({
                url: '/Kullanici/DuvarResimleriPartial',
                type: "Get",
                contentType: false,
                beforeSend: function () {
                    $("#loadingDiv").css('display', 'block');
                },
                complete: function () {
                    $("#loadingDiv").css('display', 'none');

                },
                processData: false,
                success: function (result) {
                    $("#divModalDuvarResmi").html(result);

                },
                error: function () {

                }
            });

        };

        function filevalidationFotograf() {
            const fi = document.getElementById('fileInputHiddenFotograf');
            // Check if any file is selected.
            if (fi.files.length > 0) {
                for (const i = 0; i <= fi.files.length - 1; i++) {

                    const fsize = fi.files.item(i).size;
                    const file = Math.round((fsize / 1024));
                    // The size of the file.
                    if (file >= 2048) {
                        Swal.fire({
                            title: 'Hata!',
                            text: "Fotoğraf Yüklenemedi ! Lütfen dosya boyutu 2MB dan küçük dosya yükleyiniz. ",
                            icon: 'error',
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Kapat'
                        }); return false;
                    }
                    return true;
                }
            }
        }

        function showFotografGalerisiLoading() {
            $('#fotografGalerisi').loadingModal({ text: 'Lütfen Bekleyin...' });
            $('#fotografGalerisi').loadingModal('animation', 'cubeGrid');
        };

        function hideFotografGalerisiLoading(id) {
            $('#fotografGalerisi').loadingModal('destroy');
        };

        function kullaniciProfilResimModalGetir() {
        var middleContent = $('#ProfilFotografPartialGetir');
        middleContent.html('');
        middleContent.load('@Url.Action("ProfilFotografPartial", "Kullanici")', function () {
            $('#update-profile-photo').modal('show');
        });
    }
    </script>
}
